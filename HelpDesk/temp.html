<label class="control-label" for="inputDefault">Номер</label>
<input type="text" class="form-control" id="inputNumber">
<label class="control-label" for="inputDefault">Руководитель</label>
<select class="form-control" id="selectChief">
                    {% for i in chiefs %}
                    <option value ="{{i.id}}" >{{i.name}}</option>
                    {% endfor %}
             </select>
<label class="control-label" for="inputDefault">Заявитель</label>
<input type="text" class="form-control" id="inputClient">
<label class="control-label" for="inputDefault">Комментарии</label>
<input type="text" class="form-control" id="inputComments">
<label class="control-label" for="inputDefault">Дата выполнения</label>
<input type="text" class="form-control" id="inputComplete">
<label class="control-label" for="inputDefault">Кабинет</label>
<input type="text" class="form-control" id="inputOffice">
<label class="control-label" for="inputDefault">Дата заявки</label>
<input type="text" class="form-control" id="inputReceipt">
<label class="control-label" for="inputDefault">Отчет</label>
<input type="text" class="form-control" id="inputReport">
<label class="control-label" for="inputDefault">Статус заявки</label>
<select class="form-control" id="selectStatus">
                  {% for i in statuses %}
                    <option value ="{{i.id_status}}" >{{i.name}}</option>
                    {% endfor %}
             </select>
<label class="control-label" for="inputDefault">Корпус</label>
<select class="form-control" id="selectStructure">
                  {% for i in structures %}
                    <option value ="{{i.id_str}}" >{{i.name}}</option>
                    {% endfor %}
             </select>
<label class="control-label" for="inputDefault">Другие работы</label>
<input type="text" class="form-control" id="inputTaskOther">
<label class="control-label" for="inputDefault">Исполнитель</label>
<select class="form-control" id="selectWorker">
                  {% for i in workers %}
                    <option value ="{{i.id}}" >{{i.name}}</option>
                              {% endfor %}
             </select>
<form method="POST" class="post-form" action="{% url 'change_request'%}">
    {% csrf_token %} {{ form }}
    <button type="submit" on-tap="this.form.submit()">Save</button>
</form>
<button type="submit" class="btn btn-primary" id="buttonSave" on-tap="this.form.submit()">Save changes</button>










////////////////////////


{% extends "base.html" %} 
{% block title %} Requests {% endblock %} 
{% block content %}
<div class="panel panel-primary">
    <div class="panel-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="table">
                <thead>
                    <tr>
                        <td>Номер</td>
                        <td>Фамилия</td>
                        <td>Корпус</td>
                        <td>Кабинет</td>
                        <td>Телефон</td>
                        <td>Руководитель</td>
                        <td>Исполнитель</td>
                        <td>Дата поступления</td>
                        <td>Дата исполнения</td>
                        <td>Звонок</td>
                        <td>Статус</td>
                    </tr>
                </thead>
                <tbody>
                    {% for i in matches %}
                    <tr class="success" id="{{ i.number }}" onclick="get_request(this)" data-url="{% url 'edit_request' i.number%}">
                        <td>{{ i.number }}</td>
                        <td>{{ i.client }}</td>
                        <td>{{ i.structure.name }}</td>
                        <td>{{ i.office }}</td>
                        <td>{{ i.phone_number }}</td>
                        <td>{{ i.chief.name }}</td>
                        <td>{{ i.worker.name }}</td>
                        <td>{{ i.receipt|date:"D d M Y" }}</td>
                        <td>{{ i.complete|date:"D d M Y"}}</td>
                        <td>{{ i.call }}</td>
                        <td>{{ i.request_status.name }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>



<div class="modal fade" tabindex="-1" role="dialog" id="myModal">
    <div class="modal-dialog modal-custom-large" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 id="title" class="modal-title"></h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <form action="{% url 'change_request'%}" method="POST" id="forms">
                        {% csrf_token %}
                        
                        <div class="col-sm-6">
                        <label class="control-label" for="id_client">Заявитель</label>
                        <input type="text" name="client" class="form-control" id="inputClient">
                        </div>

                         <div class="col-sm-6">                       
                        <label class="control-label" for="id_phone_number">Номер</label>
                        <input type="text" name="phone_number" class="form-control" id="inputNumber">
                         </div>

                        <label class="control-label" for="id_worker">Исполнитель</label>
                        <select class="form-control" name="worker" id="selectWorker">
                        {% for id, name in form.fields.worker.choices %}
                        <option value ="{{id}}" >{{name}}</option>
                        {% endfor %}</select>                         

                        <label class="control-label" for="selectChief">Руководитель</label>
                        <select class="form-control" name="chief"  id="selectChief">
                        {% for id, name in form.fields.chief.choices %}
                        <option value ="{{id}}" >{{name}}</option>
                        {% endfor %}</select>
            
                        <label class="control-label" for="id_request_status">Статус заявки</label>
                        <select class="form-control" name="request_status" id="selectStatus">
                        {% for id, name in form.fields.request_status.choices %}
                        <option value ="{{id}}" >{{name}}</option>
                        {% endfor %}</select>
                        
                        <h5>Оборудование</h5>
                        {{form.tasks}}
                        <!--{% for id, name in form.fields.tasks.choices %}
                        <label for="">
                        <input id="" name="tasks" type="checkbox" value="{{id}}">{{name}}
                        </label>
                        {% endfor %}-->
                        <button type="submit" class="btn btn-primary" id="buttonSave" on-tap="this.form.submit()">Save changes</button>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="buttonSave" on-tap="this.form.submit()">Save changes</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{% endblock %}





/////////////////////////////////////////////////////
$(document).ready(function () {
    $('button').click(function () {
        $('#myModal').modal('show');
    });

    $('#myModal').on('hidden.bs.modal', function () {
        $('input[type=checkbox]').each(function () {
            // console.log(parseInt(this.value))
            $(this).prop('checked', false);
        });
    })
});

function get_request(sender) {
    $('#myModal').modal('show');
    console.log(sender.getAttribute('id'));
    request_id = sender.getAttribute('id');
    $.ajax({
        url: "/helpdesk/request/",
        data: {
            'request_id': request_id
        },
        success: function (data) {
            console.log(data.tasks);
            $('.modal-title').text(data.request_data[0].client);
            $('#inputNumber').val(data.request_data[0].phone_number);
            $('#inputClient').val(data.request_data[0].client);
            $('#inputComments').val(data.request_data[0].comments);
            $('#inputComplete').val(data.request_data[0].complete);
            $('#inputOffice').val(data.request_data[0].office);
            $('#inputReceipt').val(data.request_data[0].receipt);
            $('#inputReport').val(data.request_data[0].report);
            $('#inputTaskOther').val(data.request_data[0].task_other);

            $('#selectStructure').val(data.request_data[0].structure);
            $('#selectWorker').val(data.request_data[0].worker_id);
            $('#selectStatus').val(data.request_data[0].request_status_id);
            $('#selectChief').val(data.request_data[0].chief_id);
            var choises = new Array()
            $(data.tasks).each(function () {
                choises.push(this.tasklist)
            });
            console.log(choises)

            $('input[type=checkbox]').each(function () {
                if (choises.indexOf(parseInt(this.value)) > -1)
                    $(this).prop('checked', true); //true to check else false uncheck
            });
        },
    });
}

$("#modal-book").on("submit", "#form", saveForm);

var saveForm = function () {
    var form = $(this);
    $.ajax({
        url: form.attr("action"),
        data: form.serialize(),
        type: form.attr("method"),
        dataType: 'json',
    });
    return false;
};